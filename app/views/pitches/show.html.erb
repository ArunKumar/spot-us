<% content_for :head do %>
  	<%= auto_discovery_link_tag(:rss, {:controller => 'pitches', :action => 'show', :id => @pitch.to_param, :tab=>"posts", :format => 'rss'}) %>
	<script>
    jQuery(document).ready(function($){
		jQuery("#show_action_items").click(function(){
			jQuery.facebox(jQuery("#action_buttons").html());
		});

		function selectTab(container, id){
			header = container.find('ul');
			header.find('li').removeClass('active');
			header.find(id+'_tab').addClass('active');
			$('#'+container).find('div').hide();
			$('#'+container).find(id+'_content').show();
			return false;
		}
    });
	
  	</script>
<% end %>
<% @title = "Spot.us - Pitch: #{h @pitch.headline}" %>

<% if @subscriber && @subscriber.errors.any? %>
  <div class="error">
    <%= error_messages_for :subscriber %>
  </div>
<% end %>

<div id="news_item">
   <div id="news_item_header">
      <img width="62" height="53" align="left" style="padding-right: 10px;" src="/images/new_design/pitch.png"/>
      <h2 class="headline"><%= h @pitch.headline %></h2>
   </div>
   <div class="right-column">
      <%= render :partial => 'action_buttons', :locals => {:pitch => @pitch} %>
      <div class="right-panel-box">
         <div class="donate_option">
         <h2>MAKE A DIFFERENCE</h2>
         <%= render :partial => "donations/button", :locals => { :news_item => @pitch } %>
         <%= due_date_in_words(@pitch.expiration_date) %>
         </div>
         <div class="donate_option">
         <%= link_to image_tag("/images/new_design/donate-talent.png", :class => "display_block"), pitch_assignments_path(@pitch), :title => 'Join Reporting Team' %>
         <%= link_to(pluralize(@pitch.assignments.open.size, "assignments"), pitch_assignments_path(@pitch)) %>
         </div>
      </div>
   
      <div class="right-panel-box clearfix">
         <div class="share">
         <h3>Share</h3>
			<a title="Share this Pitch on Facebook" target="_blank" rel="nofollow" href="http://www.facebook.com/share.php?u=<%=@pitch.short_url(request.url)%>&amp;t=<%= h @pitch.status_update(false) %>">
		 		<%= image_tag("/images/new_design/facebook.png") %>
			</a>
			<a  target="_blank" rel="nofollow" href="http://twitter.com/home?status=<%=h @pitch.status_update %>%>" title="Share this Pitch on Twitter"><%= image_tag("/images/new_design/twitter.png") %></a>
         </div>
         <div class="subscribe">
         <%= render :partial => 'subscriber_form', :locals => {:pitch => @pitch} %>
         <img align="right" src="update-button.png"/>
         </div>
      </div>
      
      <div id="supporters">
          <%= render :partial => "news_items/organizational_supporters", :locals => {:news_item => @pitch} %>
          <%= render :partial => "group_supporters", :locals => {:news_item => @pitch} %>
          <%= render :partial => "supporters", :locals => {:news_item => @pitch} %>
      </div>
   </div>
   <div class="main-column">
      <div class="folded-headers-big">
         <div class="news_item_author">
            <%= link_to image_tag(@pitch.user.photo(:thumb), :class => "avatar"), profile_path(@pitch.user) %>
            <h5>Author</h5>
            <%= link_to @pitch.user.full_name, profile_path(@pitch.user), :class => "username" %>
         </div>
         <% if @pitch.peer_reviewer %>
         <div class="news_item_author">
            <%= link_to(image_tag(@pitch.peer_reviewer.photo.url(:thumb), :class => "avatar"), profile_path(@pitch.peer_reviewer)) %>
            <h5>Peer Review Editor</h5>
            <%= link_to(h(@pitch.peer_reviewer.full_name), profile_path(@pitch.peer_reviewer), :class => "username") %>
         </div>
         <% end %>
      </div>
      <% unless @pitch.video_embed.blank? %>
         <div class="media-box">
            <h3>Multimedia</h3>
            <div class="align-center">
               <%= @pitch.video_embed %>
            </div>
         </div>
      <% end %>
      <div id="news_item_info">
         <div>
            <ul class="tabs">
               <li><a href="<%=pitch_path(@pitch)%>" class="tab<%= active_tab_class?(@tab, '')%>">Description</a></li>
               <li><a href="<%=pitch_path(@pitch)%>/posts" class="tab<%= active_tab_class?(@tab, 'posts')%>">Story updates (<%=@pitch.posts.size%>)</a></li>
               <li><a href="<%=pitch_path(@pitch)%>/comments" class="tab<%= active_tab_class?(@tab, 'comments')%>">Comments (<%=@pitch.comments.size%>)</a></li>
               <li><a href="<%=pitch_path(@pitch)%>/assignments" class="tab<%= active_tab_class?(@tab, 'assignments')%>">Assignments (<%=@pitch.assignments.size%>)</a></li>
			</ul>
            <% if active_tab?(@tab, '')%>
				<div class="description_tab tab_panel clearfix">
	               <%= image_tag(@pitch.featured_image.url(:medium), :class => "featured_image") %>
	               <%= @pitch.short_description %>
					<%unless @pitch.extended_description.blank?%>
	            		<h3>How will it help?</h3>
						<p>
							<%= @pitch.extended_description %>
						</p>
					<%end%>
				</div>
			<%end%>
			<% if active_tab?(@tab, 'posts')%>
	            <div class="story_tab tab_panel">
	               <h2>Story Updates</h2>
	               <% if @pitch.posts.any? %>
	                  <ul>
	                  <% @pitch.posts.each do |post| %>
	                     <li>
	                        <h4 class="title"><%= link_to h(post.title), pitch_post_path(@pitch, post) %></h4>
	                        <div class="date"><%= medium_date(post.created_at) %></div>
	                        <%= post.body %>
	                     </li>
	                  <% end %>
	                  </ul>
	               <% else %>
	                  <p>
	                     <em>This story has no blog posts.</em>
	                  </p>
	               <% end %>
	            </div>
			<%end%>
			<% if active_tab?(@tab, 'comments')%>
	            <div class="comments_tab tab_panel">
	               <% if !@pitch.comments.any? %>
	                  <p>There are no comments yet, be the first!</p>
	               <% else %>
	                  <ul>
	                     <% @pitch.comments.each do |comment| %>
							<a name="<%=comment.id%>">
	                        <li>
	                           <h5><%= comment.title %></h5>
	                           <%= link_to image_tag(comment.user.photo(:medium), :class => "avatar"), profile_path(comment.user) %>
	                           <div class="comment"><%= comment.body %>
	                              by <%= link_to comment.user.full_name, profile_path(comment.user) %> on <%= comment.created_at.to_s(:long_date) %>
	                           </div>
	                        </li>
	                     <% end %>
	                  </ul>
	               <% end %>
	               <h3>Post A Comment</h3>
	               <% form_for [@pitch, Comment.new(:commentable => @pitch)], :html => { :id => 'comments_form', :class => "auth" } do |f| %>
	                  <%= render :partial => 'comments/form', :locals => {:f => f} %>
	               <% end %>
	            </div>
			<%end%>
			<% if active_tab?(@tab, 'assignments')%>
	            <div class="assignments_tab tab_panel">
	               <% if @pitch.assignments.any? %>
	                  <%= render :partial => 'assignments', :locals => {:pitch => @pitch}%>
	               <% else %>
	                  Not every pitch has assignments. Like large cats, some reporters like to work
	                  alone. Check to see if other pitches do have assignments you can help out with!
	               <% end %>
	            </div>
			<%end%>
         </div>
         <br/><br/>
         <div id="tabContainer">
            <ul class="tabs" id="tabHeader">
               	<li><a href="" class="tab active" id="qualifications_tab" onclick="selectTab('tabContainer','qualifications');">Qualifications</a></li>
				<li><a href="" class="tab" id="deliverables_tab" onclick="selectTab('tabContainer','deliverables');">Deliverables</a></li>
            </ul>
            <div class="qualifications_tab tab_panel" id="qualifications_content">
               <%= h @pitch.skills %>
            </div> 
			<div class="deliverables_tab tab_panel hide" id="deliverables_content">
               <%= h @pitch.delivery_description %>
            </div>
         </div>
      </div>
   </div>
</div>
